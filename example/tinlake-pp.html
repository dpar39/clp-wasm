<!DOCTYPE html>
<html>
  <head>
    <title>CLP Solver Demo</title>
    <meta content="" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <link rel="stylesheet" href="/resources/demos/style.css" />
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="bn.js"></script>
    <script src="tinlake.js"></script>
    <style>
      html,
      body {
        height: 100vh;
      }
      textarea {
        width: 100%;
        font-family: "Courier New", Courier, monospace;
        font-size: small;
      }
      .slider {
        -webkit-appearance: none; /* Override default CSS styles */
        appearance: none;
        width: 100%; /* Full-width */
        height: 25px; /* Specified height */
        background: #d3d3d3; /* Grey background */
        outline: none; /* Remove outline */
        opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
        -webkit-transition: 0.2s; /* 0.2 seconds transition on hover */
        transition: opacity 0.2s;
      }

      .slider:hover {
        opacity: 1; /* Fully shown on mouse-over */
      }

      .nopadding {
        padding: 0 !important;
        margin: 0 !important;
      }
      input {
        text-align: right;
      }
      .w-49 {
        width: 49%;
      }

      .value {
        width: 68px;
      }
      .exp {
        width: 45px;
      }
      .add {
        width: 45px;
      }
      .infeasible {
        background-color: rgb(197, 116, 116);
      }

      h6 {
        color: lightslategray;
      }

      .ui-slider .ui-slider-handle {
        border: 1px solid black;
        padding: 0px 4px !important;
        width: 10px;
      }

      .out-slider {
        border-color: transparent !important;
      }

      .out-slider .ui-slider-handle {
        border: 1px solid green !important;
        background-color: green;
        opacity: 1 !important;
      }
      .bb {
        border-bottom: 1px solid lightgray;
      }
    </style>
  </head>
  <body onload="init()">
    <script src="clp-wasm.js" type="text/javascript"></script>
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <h3 class="text-center mt-2 mb-3">Tinlake solver playpen</h3>
        </div>
      </div>
      <div class="row my-1 bb">
        <div class="col">
          <h6 class="">Weights</h6>
        </div>
      </div>
      <div class="row my-1">
        <div class="col">
          <p class="text-center">TIN Invest</p>
          <input id="tinInvestWeight" type="text" class="w-100" />
        </div>
        <div class="col">
          <p class="text-center">DROP Invest</p>
          <input id="dropInvestWeight" type="text" class="w-100" />
        </div>
        <div class="col">
          <p class="text-center">TIN Redeem</p>
          <input id="tinRedeemWeight" type="text" class="w-100" />
        </div>
        <div class="col">
          <p class="text-center">DROP Redeem</p>
          <input id="dropRedeemWeight" type="text" class="w-100" />
        </div>
      </div>

      <div class="row mt-3 mb-1 bb">
        <div class="col">
          <h6>State</h6>
        </div>
      </div>
      <div class="row">
        <div class="col-3">
          <p class="text-center">Senior Asset</p>
          <div id="seniorAssetSlider" class="w-49 d-inline-block"></div>
          <input class="value" type="number" id="seniorAssetValue" /> E
          <input class="exp" type="number" id="seniorAssetExp" /> +
          <input class="add" type="number" id="seniorAssetAdd" />
        </div>
        <div class="col-3">
          <p class="text-center">Net Asset Value</p>
          <div
            id="netAssetValueSlider"
            class="w-49"
            style="display: inline-block"
          ></div>
          <input class="value" type="number" id="netAssetValueValue" /> E
          <input class="exp" type="number" id="netAssetValueExp" /> +
          <input class="add" type="number" id="netAssetValueAdd" />
        </div>
        <div class="col-3">
          <p class="text-center">Reserve</p>
          <div id="reserveSlider" class="w-49 d-inline-block"></div>
          <input class="value" type="number" id="reserveValue" /> E
          <input class="exp" type="number" id="reserveExp" /> +
          <input class="add" type="number" id="reserveAdd" />
        </div>
        <div class="col-3">
          <p class="text-center">Max Reserve</p>
          <div id="maxReserveSlider" class="w-49 d-inline-block"></div>
          <input class="value" type="number" id="maxReserveValue" /> E
          <input class="exp" type="number" id="maxReserveExp" /> +
          <input class="add" type="number" id="maxReserveAdd" />
        </div>
      </div>
      <div class="row mb-2 mt-4">
        <div class="col-1">
          <p>TIN ratio</p>
        </div>
        <div class="col-2 text-right">
          <input
            id="minTinRatioValue"
            type="number"
            class="sliderValue"
            data-index="0"
            value="0.15"
            min="0"
            step="0.001"
            max="1"
          />
        </div>
        <div class="col my-auto">
          <div id="tinRatioSlider"></div>
        </div>
        <div class="col-2">
          <input
            id="maxTinRatioValue"
            type="number"
            class="sliderValue"
            data-index="1"
            value="0.2"
            min="0"
            step="0.001"
            max="1"
          />
        </div>
      </div>

      <div class="row my-1 bb">
        <div class="col">
          <h6>Orders</h6>
        </div>
      </div>
      <div class="row my-1" id="ordersRow">
        <div class="col-6">
          <p class="text-center">TIN Invest</p>
          <table class="w-100">
            <tr>
              <td class="w-50">
                <div id="tinInvestSlider" class="mt-1 mb-2 w-100"></div>
                <div id="tinInvestSliderOut" class="my-1 w-100"></div>
              </td>
              <td class="w-50">
                <input class="value" type="number" id="tinInvestValue" /> E
                <input class="exp" type="number" id="tinInvestExp" /> +
                <input class="add" type="number" id="tinInvestAdd" />
              </td>
            </tr>
          </table>
        </div>
        <div class="col-6">
          <p class="text-center">DROP Invest</p>
          <table class="w-100">
            <tr>
              <td class="w-49">
                <div id="dropInvestSlider" class="mt-1 mb-2 w-100"></div>
                <div id="dropInvestSliderOut" class="my-1 w-100"></div>
              </td>
              <td class="w-49">
                <input class="value" type="number" id="dropInvestValue" /> E
                <input class="exp" type="number" id="dropInvestExp" /> +
                <input class="add" type="number" id="dropInvestAdd" />
              </td>
            </tr>
          </table>
        </div>
        <div class="col-6">
          <p class="text-center">TIN Redeem</p>
          <table class="w-100">
            <tr>
              <td class="w-50">
                <div id="tinRedeemSlider" class="mt-1 mb-2 w-100"></div>
                <div id="tinRedeemSliderOut" class="my-1 w-100"></div>
              </td>
              <td class="w-50">
                <input class="value" type="number" id="tinRedeemValue" /> E
                <input class="exp" type="number" id="tinRedeemExp" /> +
                <input class="add" type="number" id="tinRedeemAdd" />
              </td>
            </tr>
          </table>
        </div>
        <div class="col-6">
          <p class="text-center">DROP Redeem</p>
          <table class="w-100">
            <tr>
              <td class="w-49">
                <div id="dropRedeemSlider" class="mt-1 mb-2 w-100"></div>
                <div id="dropRedeemSliderOut" class="my-1 w-100"></div>
              </td>
              <td class="w-49">
                <input class="value" type="number" id="dropRedeemValue" /> E
                <input class="exp" type="number" id="dropRedeemExp" /> +
                <input class="add" type="number" id="dropRedeemAdd" />
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="btn btn-primary m-2" onclick="importTestCase()">
            Import Test Case
          </div>
    
          <div class="btn btn-primary m-2" onclick="exportTestCase()">
            Export Test Case
          </div>
        </div>
      </div>
      <div class="row h-25 mt-3">
        <div class="col">
          <h5>Problem in LP format</h5>
          <textarea id="lpProblem" rows="10"></textarea>
        </div>
      </div>
      <div class="row h-25">
        <div class="col">
          <h5>Solution</h5>
          <textarea id="solution" rows="14"></textarea>
        </div>
      </div>
    </div>
    <script>
      const ordersList = ["tinInvest", "dropInvest", "tinRedeem", "dropRedeem"];
      function init() {}

      async function loadTestCase() {
        let req = await fetch("tinlake.test.json");
        let testCase = await req.json();
        setUpUi(testCase);
      }

      function getFloatParameter(name) {
        return parseFloat($(`#${name}`).val());
      }

      function getBNParameter(name) {
        const number = {
          value: parseFloat($(`#${name}Value`).val()),
          base: parseFloat($(`#${name}Exp`).val()),
        };
        const add = parseFloat($(`#${name}Add`).val());
        if (add !== 0) number["add"] = add;
        return number;
      }

      function objToNum(jsonNumber) {
        if (typeof jsonNumber == "string") {
          return new BN(jsonNumber);
        }
        const add = jsonNumber.add ? jsonNumber.add : 0;
        return new BN(jsonNumber.value * 100000)
          .mul(new BN(10).pow(new BN(jsonNumber.base - 5)))
          .add(new BN(add));
      }

      function paramsToBn(obj) {
        const resBN = {};
        for (let prop in obj) {
          if (obj.hasOwnProperty(prop)) {
            resBN[prop] = objToNum(obj[prop]);
          }
        }
        return resBN;
      }

      function prepareProblem() {
        return {
          weights: {
            tinInvest: getFloatParameter("tinInvestWeight"),
            dropInvest: getFloatParameter("dropInvestWeight"),
            tinRedeem: getFloatParameter("tinRedeemWeight"),
            dropRedeem: getFloatParameter("dropRedeemWeight"),
          },
          state: {
            seniorAsset: getBNParameter("seniorAsset"),
            netAssetValue: getBNParameter("netAssetValue"),
            reserve: getBNParameter("reserve"),
            maxReserve: getBNParameter("maxReserve"),
            minTinRatio: {
              value: getFloatParameter("minTinRatioValue"),
              base: 27,
            },
            maxTinRatio: {
              value: getFloatParameter("maxTinRatioValue"),
              base: 27,
            },
          },
          orders: {
            tinInvest: getBNParameter("tinInvest"),
            dropInvest: getBNParameter("dropInvest"),
            tinRedeem: getBNParameter("tinRedeem"),
            dropRedeem: getBNParameter("dropRedeem"),
          },
        };
      }

      function buildProblem() {
        const testCase = prepareProblem();
        solveProblem(testCase);
      }

      function exportTestCase() {
        const json = prepareProblem();
        const content = JSON.stringify(json, null, 4);
        var a = document.createElement("a");
        var file = new Blob([content], { type: "application/json" });
        a.href = URL.createObjectURL(file);
        a.download = "testCase.json";
        a.click();
      }

      function importTestCase() {
        const fileInput = document.createElement("input");
        readFile = function (e) {
          var file = e.target.files[0];
          if (!file) {
            return;
          }
          var reader = new FileReader();
          reader.onload = function (e) {
            const contents = e.target.result;
            const testCase = JSON.parse(contents);
            setUpUi(testCase);
            document.body.removeChild(fileInput);
          };
          reader.readAsText(file);
        };

        fileInput.type = "file";
        fileInput.style.display = "none";
        fileInput.onchange = readFile;
        document.body.appendChild(fileInput);
        fileInput.click();
      }

      function solveProblem(testCase) {
        testCase.state.maxDropRatio = {
          value: 1 - testCase.state.minTinRatio.value,
          base: testCase.state.minTinRatio.base,
        };
        testCase.state.minDropRatio = {
          value: 1 - testCase.state.maxTinRatio.value,
          base: testCase.state.maxTinRatio.base,
        };
        const state = paramsToBn(testCase.state);
        const orders = paramsToBn(testCase.orders);
        const res = calculateOptimalSolution(state, orders, testCase.weights);

        const isFeasible = res.isFeasible;
        $("#ordersRow").css(
          "background-color",
          !isFeasible ? "tomato" : "honeydew"
        );

        for (let order of ordersList) {
          const base = testCase.orders[order].base;
          const f = res[order];
          const exp = new BN(10).pow(new BN(base));

          const v = f.gt(exp) ? f.div(exp) : 0;
          $(`#${order}SliderOut`).slider("values", 0, v.toString());
        }
      }

      function setUpUi(testCase) {
        const orders = testCase.orders;
        const weights = testCase.weights || {
          tinInvest: 10000,
          dropInvest: 1000,
          tinRedeem: 100000,
          dropRedeem: 1000000,
        };
        const state = testCase.state;
        // Setup weights
        for (const order of ordersList) {
          const selW = `#${order}Weight`;
          $(selW).attr({ value: weights[order] });
        }

        const minTinRatio = state.minTinRatio.value || 0.15;
        const maxTinRatio = state.maxTinRatio.value || 0.2;
        $("#tinRatioSlider").slider({
          range: true,
          min: 0,
          max: 1,
          step: 0.001,
          values: [minTinRatio, maxTinRatio],
          slide: function (event, ui) {
            for (var i = 0; i < ui.values.length; ++i) {
              $("input.sliderValue[data-index=" + i + "]").val(ui.values[i]);
            }
            buildProblem();
          },
        });
        $("input.sliderValue").change(function () {
          var $this = $(this);
          $("#tinRatioSlider").slider(
            "values",
            $this.data("index"),
            $this.val()
          );
          buildProblem();
        });

        function setBigNumberParameter(name, parm) {
          const sliderSel = `#${name}Slider`;
          const inputSel = `#${name}Value`;
          $(sliderSel).slider({
            min: 0,
            max: parm.max || parm.value * 2,
            step: 1,
            values: [parm.value],
            slide: function (event, ui) {
              for (var i = 0; i < ui.values.length; ++i) {
                $(inputSel).val(ui.values[i]);
              }
              buildProblem();
            },
          });
          $(inputSel)
            .attr({ max: parm.max, min: 0, value: parm.value })
            .change(function () {
              var $this = $(this);
              $(sliderSel).slider("values", 0, $this.val());
              buildProblem();
            });
          const expSel = `#${name}Exp`;
          const addSel = `#${name}Add`;
          $(expSel)
            .attr({ value: parm.base || 18 })
            .change(() => buildProblem());
          $(addSel)
            .attr({ value: parm.add || 0 })
            .change(() => buildProblem());
        }

        const parmList = [
          "seniorAsset",
          "netAssetValue",
          "reserve",
          "maxReserve",
        ];
        for (let parmName of parmList) {
          setBigNumberParameter(parmName, state[parmName]);
        }

        for (const parmName of ordersList) {
          const parm = orders[parmName];
          setBigNumberParameter(parmName, orders[parmName]);
          const sliderSel = `#${parmName}SliderOut`;
          $(sliderSel)
            .slider({
              min: 0,
              disabled: true,
              max: parm.max || parm.value * 2,
              step: 1,
              values: [parm.value],
            })
            .addClass("out-slider");
        }
      }

      $(document).ready(() => {
        loadTestCase();
      });
    </script>
  </body>
</html>
